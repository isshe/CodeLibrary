[TOC]

编码规范
---

# 等级
* 必须遵守
* 强烈推荐
* 一般建议

# 必须遵守
* 使用 `cjson.safe` 而不是 `cjson`, `cjson.safe` 在数据格式错误时不会导致 `LuaVM` 错误， 而是返回`nil`。
* 访问后端服务使用 cosocket 而不是 ngx.location.capture。
* lua-resty-dns 需配合 lua-resty-lrucache 或其他缓存机制使用，避免每次请求都进行查询。
* 使用 SQL 时，需要注意注入问题，可以使用 ngx.quote_sql_str()转换为安全字符串。
* 使用特权进程（process.enable_privileged_agent）来做一些 worker 没有权限的任务，或者周期任务。

# 强烈推荐
* 使用 ngx.re.sub/ngx.re.gsub 时,不指定`o`选项.
* 使用正则表达式时, 尽量使用`[[]]`而不是用`""`, 避免转义.
* 如果只需要读取少数 header 字段，建议使用 ngx.var.http_xxx，以节约成本。ngx.req.get_headers()会解析所有的字段。



# 一般建议

* 使用`body_filter_by_lua`需要注意：代理里的修改可能会导致响应体数据的长度变化，最好先删除`Content-Length`字段。
* 少使用`ngx.ctx`, 因为它采用元方法调用的方式实现，成本较高。只存放少量必要的数据，避免滥用。
* 少使用 `ngx.var`, 因为它会分配少量内存，有额外开销。如需使用，存到临时变量中。



# 其他须知

* lua_socket_buffer_size 设置较大并不会显著改善性能，实际应用时可适当减小以节约内存。
* `特权进程`是特殊的 worker 进程，权限与 master 一致。



