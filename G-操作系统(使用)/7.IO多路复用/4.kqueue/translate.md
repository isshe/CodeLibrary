
[TOC]

# Kqueue
* 通用和可扩展的事件通知工具（Ageneric and scalable event notification facility）。

## 0. 摘要
当一个套接字或描述符上发生某些活动时，需要通知在UNIX平台上运行的应用程序，传统上是使用`poll()`或`select()`系统调用来完成。然而，随着描述符数量的增加，这些系统调用的性能不能很好地拓展（并不是很好）。并且这些接口也有其他的限制，如不能处理应用程序可能感兴趣的一些其他可能有趣活动。这些活动包括：信号、文件系统更改、AIO完成。本文介绍了一种通用的事件传递机制，它允许应用程序从各种事件源中进行选择，并以可扩展和有效的方式通知这些源的活动。 该机制可以扩展以覆盖未来的事件源而不改变应用程序接口。

## 1. 介绍
* 应用程序通常是事件驱动的，因为它们响应应用程序外部的事件或活动而执行其工作，并且随后以某种方式传递。因此，应用程序的性能通常取决于它能够检测和响应这些事件的效率。
* FreeBSD提供了`poll`和`select`两个用于检测文件描述符活动的系统调用。 但是，由于事件监视的描述符数量变大，因此这些调用都不能很好地扩展。 打算处理数千个描述符的高容量服务器很快发现这些调用成为瓶颈，导致性能不佳。
* 应用程序可能感兴趣的事件集不限于打开文件描述符上的活动。应用程序可能还想知道异步I/O（aio）请求何时完成，何时将信号传递给应用程序，何时文件系统中的文件以某种方式更改，或者进程何时退出。 目前这些都没有得到有效处理; 信号传递是有限且昂贵的，并且列出的其他事件需要低效的轮询模型。 此外，poll和select都不能收集这些事件，导致由于使用多个通知接口而导致代码复杂性增加。
* 本文介绍了一种新机制，允许应用程序在特定事件中注册感兴趣的内容，然后在以后有效地收集事件通知。 这些机制所涵盖的事件集合不仅包括上述内容，还可以扩展到无法预见的事件源，而无需修改API。
* 本文的其余部分结构如下：第2节检查poll和select的主要瓶颈在哪里；第3节解释设计目标；第4节介绍新机制的API； 第5节详细介绍如何使用新API并提供了一些编程示例；第6节讨论内核实现；第7节是某些应用程序的性能测量；第8节讨论相关工作；第九节是总结。

## 2. 问题(select/poll的问题)
* poll和select接口的缺陷是：应用程序必须在每次调用中`传递`整个监视描述符列表。这直接导致系统在用户/内核空间存在两份内存副本，从而减少了可用于其他活动的内存带宽量。对于包含数千个描述符的大型列表，时间经验表明，通常只有几百个是活动的，因此95%的副本是不需要的。

## 3. 设计目标

## 4. Kqueue API

### 4.1 Kqueue 过滤器

## 5. 使用和示例

## 6. 实现

### 6.1 注册

### 6.2 过滤

### 6.3 事件源的活动

### 6.4 传递

### 6.5 杂项说明

## 7. 性能
